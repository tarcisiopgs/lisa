name: Auto Merge

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    steps:
      - name: Merge or notify
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { conclusion, head_branch } = context.payload.workflow_run;

            if (head_branch === 'main') {
              console.log('Push direto na main, ignorando.');
              return;
            }

            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:${head_branch}`
            });

            if (prs.data.length === 0) {
              console.log('Nenhum PR aberto para a branch:', head_branch);
              return;
            }

            const pr = prs.data[0];

            if (conclusion === 'success') {
              console.log(`‚úÖ CI passou. Mergeando PR #${pr.number}...`);

              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                merge_method: 'squash'
              });

              try {
                await github.rest.git.deleteRef({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ref: `heads/${head_branch}`
                });
                console.log(`üóëÔ∏è Branch ${head_branch} deletada.`);
              } catch (e) {
                console.log('N√£o foi poss√≠vel deletar a branch:', e.message);
              }
            } else {
              console.log(`‚ùå CI falhou para o PR #${pr.number}.`);

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: `‚ùå **CI falhou** ‚Äî merge bloqueado.\n\nStatus: \`${conclusion}\`. Verifique os logs antes de tentar novamente.`
              });

              if (process.env.NOTIFY_WEBHOOK_URL) {
                try {
                  await fetch(process.env.NOTIFY_WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json',
                      'X-Webhook-Secret': process.env.NOTIFY_WEBHOOK_SECRET
                    },
                    body: JSON.stringify({
                      repo: context.repo.repo,
                      pr_number: pr.number,
                      pr_title: pr.title,
                      pr_url: pr.html_url,
                      branch: head_branch,
                      conclusion
                    })
                  });
                  console.log('Webhook de notifica√ß√£o enviado.');
                } catch (e) {
                  console.log('Erro ao chamar webhook:', e.message);
                }
              }
            }
        env:
          NOTIFY_WEBHOOK_URL: ${{ secrets.NOTIFY_WEBHOOK_URL }}
          NOTIFY_WEBHOOK_SECRET: ${{ secrets.NOTIFY_WEBHOOK_SECRET }}
